name: Destroy Frontend Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to destroy"
        required: true
        type: choice
        options:
          - test
          - prod
      confirm_destroy:
        description: 'Type "DESTROY" to confirm (case-sensitive)'
        required: true
        type: string

env:
  AWS_REGION: us-east-1

jobs:
  destroy:
    runs-on: ubuntu-latest
    concurrency:
      group: destroy-${{ inputs.environment }}-${{ github.ref }}
      cancel-in-progress: false

    permissions:
      id-token: write
      contents: read

    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "‚ùå Confirmation failed. You must type 'DESTROY' to proceed."
            echo "Received: '${{ inputs.confirm_destroy }}'"
            exit 1
          fi
          echo "‚úÖ Confirmation validated"

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Pulumi dependencies
        working-directory: infrastructure
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Pulumi
        uses: pulumi/actions@v4
        with:
          pulumi-version: latest

      - name: Select Pulumi Stack
        working-directory: infrastructure
        run: |
          source .venv/bin/activate
          pulumi stack select ${{ inputs.environment }}
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          PULUMI_PYTHON_CMD: ${{ github.workspace }}/infrastructure/.venv/bin/python

      - name: Get Pulumi Outputs (Before Destroy)
        id: outputs
        working-directory: infrastructure
        run: |
          source .venv/bin/activate
          echo "üìã Getting current infrastructure details..."

          # Get outputs (may fail if stack doesn't exist, that's okay)
          ECR_REPO_NAME=$(pulumi stack output ecr_repository_name --stack ${{ inputs.environment }} 2>/dev/null || echo "")
          EB_ENV_NAME=$(pulumi stack output eb_environment_name --stack ${{ inputs.environment }} 2>/dev/null || echo "")
          EB_APP_NAME=$(pulumi stack output eb_application_name --stack ${{ inputs.environment }} 2>/dev/null || echo "")

          echo "ecr_repo_name=${ECR_REPO_NAME}" >> $GITHUB_OUTPUT
          echo "eb_env_name=${EB_ENV_NAME}" >> $GITHUB_OUTPUT
          echo "eb_app_name=${EB_APP_NAME}" >> $GITHUB_OUTPUT

          if [ -n "$ECR_REPO_NAME" ]; then
            echo "‚úÖ Found ECR repository: $ECR_REPO_NAME"
          fi
          if [ -n "$EB_ENV_NAME" ]; then
            echo "‚úÖ Found EB environment: $EB_ENV_NAME"
          fi
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          PULUMI_PYTHON_CMD: ${{ github.workspace }}/infrastructure/.venv/bin/python
        continue-on-error: true

      - name: Destroy Pulumi Infrastructure
        working-directory: infrastructure
        run: |
          source .venv/bin/activate
          echo "üóëÔ∏è  Destroying Pulumi infrastructure for ${{ inputs.environment }} environment..."
          echo "‚ö†Ô∏è  This will delete ALL resources managed by Pulumi!"

          pulumi destroy --yes --stack ${{ inputs.environment }}

          echo "‚úÖ Infrastructure destroyed"
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          PULUMI_PYTHON_CMD: ${{ github.workspace }}/infrastructure/.venv/bin/python

      - name: Cleanup S3 Buckets (Not Managed by Pulumi)
        run: |
          AWS_REGION="${{ env.AWS_REGION }}"
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

          echo "üóëÔ∏è  Cleaning up Elastic Beanstalk S3 buckets..."
          echo "‚ÑπÔ∏è  These buckets are NOT managed by Pulumi"
          echo "‚ÑπÔ∏è  They are created automatically by Elastic Beanstalk service"
          echo "‚ÑπÔ∏è  Pulumi destroy will NOT delete them, so we clean them up manually"

          # List and delete EB deployment buckets
          # These are created by EB service for storing:
          # - Application versions
          # - Deployment bundles (Dockerrun.aws.json, etc.)
          # - Logs and artifacts
          BUCKETS=$(aws s3 ls | grep -E "eb-deployments-|elasticbeanstalk-" | awk '{print $3}' || echo "")

          if [ -n "$BUCKETS" ]; then
            for BUCKET in $BUCKETS; do
              echo "Deleting bucket: $BUCKET"
              # Delete all objects first
              aws s3 rm s3://$BUCKET --recursive || true
              # Delete bucket
              aws s3 rb s3://$BUCKET --force || true
            done
            echo "‚úÖ S3 buckets cleaned up"
          else
            echo "‚ÑπÔ∏è  No EB S3 buckets found"
          fi
        continue-on-error: true

      - name: Verify Destruction
        run: |
          echo "üîç Verifying all resources are deleted..."

          ENV_NAME="${{ steps.outputs.outputs.eb_env_name }}"
          APP_NAME="${{ steps.outputs.outputs.eb_app_name }}"
          REPO_NAME="${{ steps.outputs.outputs.ecr_repo_name }}"
          AWS_REGION="${{ env.AWS_REGION }}"

          # Check Elastic Beanstalk environment
          if [ -n "$ENV_NAME" ]; then
            ENV_EXISTS=$(aws elasticbeanstalk describe-environments \
              --environment-names "$ENV_NAME" \
              --region "$AWS_REGION" \
              --query 'Environments[0].EnvironmentName' \
              --output text 2>/dev/null || echo "None")
            
            if [ "$ENV_EXISTS" != "None" ] && [ -n "$ENV_EXISTS" ]; then
              echo "‚ö†Ô∏è  Warning: Environment $ENV_NAME still exists"
            else
              echo "‚úÖ Environment $ENV_NAME deleted"
            fi
          fi

          # Check Elastic Beanstalk application
          if [ -n "$APP_NAME" ]; then
            APP_EXISTS=$(aws elasticbeanstalk describe-applications \
              --application-names "$APP_NAME" \
              --region "$AWS_REGION" \
              --query 'Applications[0].ApplicationName' \
              --output text 2>/dev/null || echo "None")
            
            if [ "$APP_EXISTS" != "None" ] && [ -n "$APP_EXISTS" ]; then
              echo "‚ö†Ô∏è  Warning: Application $APP_NAME still exists"
            else
              echo "‚úÖ Application $APP_NAME deleted"
            fi
          fi

          # Check ECR repository
          if [ -n "$REPO_NAME" ]; then
            REPO_EXISTS=$(aws ecr describe-repositories \
              --repository-names "$REPO_NAME" \
              --region "$AWS_REGION" \
              --query 'repositories[0].repositoryName' \
              --output text 2>/dev/null || echo "None")
            
            if [ "$REPO_EXISTS" != "None" ] && [ -n "$REPO_EXISTS" ]; then
              echo "‚ö†Ô∏è  Warning: ECR repository $REPO_NAME still exists"
            else
              echo "‚úÖ ECR repository $REPO_NAME deleted"
            fi
          fi

          echo ""
          echo "‚úÖ Destruction complete!"

      - name: Summary
        run: |
          echo "=========================================="
          echo "‚úÖ Infrastructure Destruction Complete"
          echo "=========================================="
          echo ""
          echo "Environment: ${{ inputs.environment }}"
          echo "All Pulumi-managed resources have been deleted:"
          echo "  - Elastic Beanstalk environment (managed by Pulumi)"
          echo "  - Elastic Beanstalk application (managed by Pulumi)"
          echo "  - ECR repository (managed by Pulumi)"
          echo "  - IAM roles and policies (managed by Pulumi)"
          echo "  - Instance profiles (managed by Pulumi)"
          echo "  - All other Pulumi-managed resources"
          echo ""
          echo "Note: Pulumi stack still exists but is empty."
          echo "To remove the stack: pulumi stack rm ${{ inputs.environment }}"
          echo ""
          echo "Note: S3 buckets created by Elastic Beanstalk may still exist."
          echo "These are not managed by Pulumi and were cleaned up separately."
